name: ğŸ—ï¸ AI Architect CI/CD Pipeline

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-and-test:
    name: ğŸ§ª Build & Test Docker Architecture
    runs-on: ubuntu-latest

    steps:
    # 1. Descargar cÃ³digo
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v3

    # 2. Preparar entorno (Permisos de carpetas para el volumen)
    # GitHub Actions a veces falla con volÃºmenes si la carpeta no existe
    - name: ğŸ“‚ Create Volume Directory
      run: mkdir -p qdrant_data && chmod 777 qdrant_data

    # 3. Construir y Levantar (Usando el Docker pre-instalado)
    - name: ğŸ”¨ Build and Start Services
      run: |
        echo "ğŸš€ VersiÃ³n de Docker:"
        docker compose version
        
        echo "ğŸ—ï¸ Construyendo imÃ¡genes..."
        docker compose build
        
        echo "ğŸ”¥ Levantando infraestructura..."
        docker compose up -d
        
        echo "â³ Esperando 15s para que los servicios inicien..."
        sleep 15
        
        echo "ğŸ•µï¸ Verificando estado..."
        docker compose ps
        
        # ValidaciÃ³n: Contamos si hay 3 lÃ­neas de servicios corriendo
        # El comando busca lÃ­neas que contengan "Up" o "running"
        SERVICES_UP=$(docker compose ps --services --filter "status=running" | wc -l)
        
        if [ "$SERVICES_UP" -lt 3 ]; then
          echo "âŒ ERROR: Se esperaban 3 servicios, se encontraron $SERVICES_UP."
          docker compose logs
          exit 1
        else
          echo "ğŸ‰ Ã‰XITO TOTAL: Los 3 microservicios (Frontend, API, DB) estÃ¡n vivos."
        fi

    # 4. Limpieza final
    - name: ğŸ§¹ Teardown
      if: always()
      run: docker compose down
